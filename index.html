<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Million Pixel Grid</title>
<style>
  html, body {margin:0;padding:0;overflow:hidden;height:100%;background:#222;color:#fff;font-family:sans-serif;}
  #container {display:flex;height:100%;width:100%;}
  #canvasContainer {flex:1;position:relative;overflow:hidden;background:#111;}
  canvas {background:#111;display:block;position:absolute;top:0;left:0;}
  #sidebar {width:300px;background:#333;overflow-y:auto;padding:10px;box-sizing:border-box;}
  #sidebar h2{margin-top:0;}
  .pixelSection{border:1px solid #555;padding:5px;margin:5px 0;}
  .pixelSection img{width:50px;height:50px;display:block;margin-bottom:5px;}
  button{margin:2px;}
  #controls{position:absolute;top:10px;left:10px;z-index:10;}
  #sliceToggle.sliceActive{background:orange;color:#000;}
</style>
</head>
<body>
<div id="container">
  <div id="canvasContainer">
    <canvas id="canvas"></canvas>
    <div id="controls">
      <button id="zoomIn">Zoom +</button>
      <button id="zoomOut">Zoom -</button>
      <button id="sliceToggle">Slice Tool</button>
      <button id="applySameImage">Apply Image</button>
      <button id="clearSelection">Clear</button>
    </div>
  </div>
  <div id="sidebar">
    <h2>Selected Pixels</h2>
    <div id="pixelList"></div>
    <div id="totalCost">Total Cost: 0 JOD</div>
  </div>
</div>
<script>
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const COLS=100, ROWS=100;
const PRICE_PER_PIXEL=1;

let purchasedPixels = {}; // pre-purchased pixels
let selectedPixels = [];

let scale = 10; // pixels per grid
let offsetX=0, offsetY=0;
let isDragging=false;
let dragStart={x:0,y:0};
let sliceMode=false;
let sliceRect=null;

// --- Resize canvas ---
function resize(){
  canvas.width=canvas.parentElement.clientWidth;
  canvas.height=canvas.parentElement.clientHeight;
  draw();
}
window.addEventListener('resize', resize);

// --- Draw ---
function draw(){
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.save();
  // keep canvas centered
  ctx.translate(canvas.width/2,canvas.height/2);
  ctx.scale(scale,scale);
  ctx.translate(offsetX, offsetY);

  // background grid
  ctx.fillStyle="#111";
  ctx.fillRect(-COLS/2,-ROWS/2,COLS,ROWS);

  // purchased pixels
  ctx.fillStyle="green";
  for(let key in purchasedPixels){
    const [r,c]=key.split(',').map(Number);
    ctx.fillRect(c-COLS/2, r-ROWS/2,1,1);
  }

  // selected pixels
  ctx.fillStyle="rgba(0,200,0,0.5)";
  selectedPixels.forEach(p=>{
    ctx.fillRect(p.col-COLS/2,p.row-ROWS/2,1,1);
    if(p.image){
      const img=new Image();
      img.src=p.image;
      ctx.drawImage(img,p.col-COLS/2,p.row-ROWS/2,1,1);
    }
  });

  ctx.restore();

  // slice overlay
  if(sliceRect){
    ctx.save();
    ctx.strokeStyle="orange";
    ctx.lineWidth=2;
    ctx.setLineDash([6,3]);
    ctx.strokeRect(sliceRect.x, sliceRect.y, sliceRect.w, sliceRect.h);
    ctx.restore();
  }
}

// --- Zoom centered ---
function zoom(factor){
  scale*=factor;
  draw();
}
document.getElementById('zoomIn').onclick=()=>zoom(1.25);
document.getElementById('zoomOut').onclick=()=>zoom(0.8);

// --- Drag to pan ---
canvas.addEventListener('mousedown', e=>{
  if(sliceMode){
    sliceRect={x:e.offsetX,y:e.offsetY,w:0,h:0};
  }else{
    isDragging=true;
    dragStart={x:e.clientX, y:e.clientY};
  }
});
canvas.addEventListener('mousemove', e=>{
  if(sliceMode && sliceRect){
    sliceRect.w=e.offsetX-sliceRect.x;
    sliceRect.h=e.offsetY-sliceRect.y;
    draw();
  }
  if(isDragging){
    const dx=(e.clientX-dragStart.x)/scale;
    const dy=(e.clientY-dragStart.y)/scale;
    offsetX+=dx;
    offsetY+=dy;
    dragStart={x:e.clientX, y:e.clientY};
    draw();
  }
});
canvas.addEventListener('mouseup', e=>{
  if(sliceMode && sliceRect){
    const rect=sliceRect;
    const cx=(rect.x-canvas.width/2)/scale-offsetX;
    const cy=(rect.y-canvas.height/2)/scale-offsetY;
    const w=rect.w/scale;
    const h=rect.h/scale;
    for(let r=Math.floor(cy); r<Math.ceil(cy+h); r++){
      for(let c=Math.floor(cx); c<Math.ceil(cx+w); c++){
        if(!purchasedPixels[`${r},${c}`] && !selectedPixels.find(p=>p.row===r && p.col===c)){
          selectedPixels.push({row:r,col:c,image:null,link:""});
        }
      }
    }
    sliceRect=null;
    updateSidebar();
    draw();
  }
  isDragging=false;
});

// --- Toggle slice ---
const sliceBtn=document.getElementById('sliceToggle');
sliceBtn.onclick=()=>{
  sliceMode=!sliceMode;
  sliceBtn.className=sliceMode?"sliceActive":"";
};

// --- Apply same image ---
document.getElementById('applySameImage').onclick=()=>{
  const input=document.createElement('input');
  input.type='file'; input.accept='image/*';
  input.onchange=e=>{
    const file=e.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=ev=>{
      selectedPixels.forEach(p=>p.image=ev.target.result);
      updateSidebar();
      draw();
    }
    reader.readAsDataURL(file);
  }
  input.click();
}

// --- Clear ---
document.getElementById('clearSelection').onclick=()=>{
  selectedPixels=[];
  updateSidebar();
  draw();
}

// --- Sidebar ---
function updateSidebar(){
  const list=document.getElementById('pixelList');
  list.innerHTML='';
  selectedPixels.forEach((p,i)=>{
    const div=document.createElement('div');
    div.className='pixelSection';
    div.innerHTML=`<div>Row:${p.row} Col:${p.col}</div>
      <input type="text" value="${p.link||''}" placeholder="URL" data-index="${i}" class="linkInput">
      <button data-index="${i}">Remove</button>`;
    if(p.image){
      const img=document.createElement('img');
      img.src=p.image;
      div.insertBefore(img,div.firstChild);
    }
    list.appendChild(div);
  });
  list.querySelectorAll('button').forEach(btn=>{
    btn.onclick=()=>{selectedPixels.splice(btn.dataset.index,1); updateSidebar(); draw();}
  });
  list.querySelectorAll('.linkInput').forEach(inp=>{
    inp.oninput=()=>{selectedPixels[inp.dataset.index].link=inp.value;}
  });
  document.getElementById('totalCost').textContent=`Total Cost: ${selectedPixels.length*PRICE_PER_PIXEL} JOD`;
}

// --- Initialize ---
resize();
</script>
</body>
</html>
